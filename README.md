# Тестовая сборка deb-пакета для сервиса zookeeper
### Описание:
Собирать и разворачивать пакет будем на  **Ubuntu 14.04 (Trusty Tahr)**.
В качестве виртуальной среды выступит **Vagrant** с провайдером VirtualBox.
В качестве менеджера конфигураций используется Ansible,для него написаны две небольшие роли:
* **zookeeper-os** - конфигурация системы и установка необходимых для сборки пакетов
* **zookeeper-build-deb** - сборка и установка пакета.

После установки будет запущено  **smoke-тестирование** сервиса с помощью скрипта **start_smoke_test.py**.

### Запуск
Чтобы запустить сборку необходимо склонировать репозиторий,перейти в каталог zookeeper_build_deb и запустить bash-скрипт **run_build.sh**. Он нужен для того,чтобы пользователь мог выбрать режим сборки.

### Режимы сборки
* **1. Автоматическая сборка** - нет интерактивного режима: нет ввода promt (запись в changelog перед сборкой пакета), а также все extra-vars для Ansible должны указываться в файле Vagrantfile_auto в блоке ansible.extra_vars.
* **2. Полуавтоматическая сборка** - сборка происходит интерактивно,есть возможность ввода promt.

```python
git clone https://github.com/grizzlybite/zookeeper_build_deb.git
cd zookeeper_build_deb
bash run_build.sh
```

### Сборка пакета
Собирать будем с помощью **dh_make** и **debuild**:
1. Все действия будут проходить в каталоге  /tmp/zookeeper-{{ version }}.
2. Cоздаём специального пользователя builder, все команды для сборки выполняются под ним.
3. Скачиваем текущую stable версию zookeeper
4. С помощью dh_make генерируем "скелет" нашей сборки.
5. Создаем 3 файла:
 - **control** - в нем описываем мета информацию о пакете и исходниках.
 - **rules** - здесь описываем как именно будет ставится пакет.**В файле обязательно должны быть использованы символы табуляции, а не 4 пробела.**
 - **postinst** - указываем команды, которые необходимо выполнить после установки,в данном случае:
    - настройка конфига zookeeper
    - добавление сервиса в автозагрузку
    - старт сервиса  после установки

### Запуск smoke-тестов
После установки пакета происходит запуск скрипта start_smoke_test.py
Выполняются следующие проверки:
 - доступность порта
 - состояние сервиса
 - получение статистики









